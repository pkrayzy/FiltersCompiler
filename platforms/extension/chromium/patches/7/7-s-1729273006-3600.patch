d1 2
a2 2
! Checksum: 4OB5rIEjuOA9FSHmZc32mg
! Diff-Path: ../patches/7/7-s-1729319795-3600.patch
d5 2
a6 2
! Version: 2.0.58.4
! TimeUpdated: 2024-10-19T06:33:07+00:00
d507 3
a509 3
!+ NOT_PLATFORM(ext_ff)
wiki.yjsnpi.nu#%#//scriptlet('set-constant', 'r8', 'noopFunc')
wiki.yjsnpi.nu#%#const shuffleArray=e=>e.sort((()=>Math.random()-Math.random()));function fetchComments(e){const t=new XMLHttpRequest;let n;t.onreadystatechange=()=>{4===t.readyState&&200===t.status&&(n=JSON.parse(t.responseText),renderComments(n))},t.open("GET","/comments/comments.php?article_id="+RLCONF.wgArticleId+"&cursor="+e,!0),t.send()}function fetchMore(e){fetchComments(e.target.dataset.cursor)}function renderComments(e){const t=document.querySelector("#comments"),n=document.querySelector("#comments-contents"),o=document.querySelector("#comments-loading"),c=document.querySelector("#comments-more"),m=document.querySelector("#comments-recent");if(o&&o.remove(),c&&c.remove(),e.comments.forEach((e=>{const n=window.comments.template.querySelector("#comment").cloneNode(!0);n.id="comment-"+e.number,n.dataset.commentId=e.comment_id,n.querySelector(".comment-author").innerHTML=e.author,n.querySelector(".comment-timestamp").innerHTML=e.created_at,n.querySelector(".comment-body").innerHTML=e.comment,t.appendChild(n)})),e.cursor>0){const t=window.comments.template.querySelector("#comments-more").cloneNode(!0);t.dataset.cursor=e.cursor,t.addEventListener("click",fetchMore),n.appendChild(t)}const r=document.createElement("ul");e.recent=shuffleArray(e.recent),e.recent.forEach((e=>{const t=document.createElement("li"),n=document.createElement("a");n.href="/w/index.php?curid="+e.article_id,e.comment.length>70&&(e.comment=e.comment.substring(0,70)+"&hellip;"),n.innerHTML=e.comment,t.appendChild(n),r.appendChild(t)})),m.appendChild(r.cloneNode(!0)),m.appendChild(r.cloneNode(!0)),"#comments-section"==location.hash&&(location.hash="",location.hash="#comments-section")}function submitComment(e){const t=document.querySelector('#comment-editor input[name="author"]'),n=document.querySelector("#comment-editor textarea");if(""==n.value)return void mw.notify("（本文が）ないです");e.target.disabled=!0,e.target.innerHTML="送信中…";const o={article_id:RLCONF.wgArticleId,author:t.value,comment:n.value},c=[];for(const[e,t]of Object.entries(o))c.push(`${encodeURIComponent(e)}=${encodeURIComponent(t)}`);const m=new XMLHttpRequest;m.onreadystatechange=()=>{4===m.readyState&&(e.target.disabled=!1,e.target.innerHTML="投稿する",200===m.status?(mw.notify("投稿しました"),t.value="",n.value="",document.querySelector("#comments").innerHTML="",document.querySelector("#comments-recent").innerHTML="",setTimeout((()=>{fetchComments(0)}),"100")):403===m.status?mw.notify("（フリーWi-Fiからは書け）ないです"):429===m.status?mw.notify("書きすぎィ！ちょっと待って、どうぞ！"):mw.notify("投稿できませんでした…"))},m.open("POST","/comments/comments.php"),m.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),m.send(c.join("&").replace(/%20/g,"+"))}window.addEventListener("load",(()=>{if(0==RLCONF.wgNamespaceNumber&&"view"==RLCONF.wgAction&&0!=RLCONF.wgArticleId&&!RLCONF.wgIsRedirect&&RLCONF.wgRevisionId==RLCONF.wgCurRevisionId){"#comments-section"==location.hash&&window.scroll(0,document.documentElement.scrollHeight-document.documentElement.clientHeight),window.comments={};const e=new XMLHttpRequest;e.onreadystatechange=()=>{4===e.readyState&&200===e.status&&(window.comments.template=(new DOMParser).parseFromString(e.responseText,"text/html").body,document.querySelector("#bodyContent").appendChild(window.comments.template.querySelector("#comments-section")),document.querySelector("#comment-submit").addEventListener("click",submitComment),fetchComments(0))},e.open("GET","/comments/template.html",!0),e.send()}}));
